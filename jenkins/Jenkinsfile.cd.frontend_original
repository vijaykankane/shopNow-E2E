pipeline {
  agent any
  parameters {
    string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Image tag to deploy')
  }
  environment {
    REGISTRY = "your.registry.example.com/shopnow"
    KUBECONFIG_FILE = 'kubeconfig-credential' // Jenkins file credential containing kubeconfig
    RELEASE_NAME = 'shopnow-frontend'
    NAMESPACE = 'shopnow-demo'
    CHART_PATH = 'charts/frontend'
  }
  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Deploy (Helm)') {
      steps {
        withCredentials([file(credentialsId: KUBECONFIG_FILE, variable: 'KUBECONFIG')]) {
          sh '''
            export KUBECONFIG=$KUBECONFIG
            helm upgrade --install ${RELEASE_NAME} ${CHART_PATH} \
              --namespace ${NAMESPACE} --create-namespace \
              --set image.repository=${REGISTRY}-frontend \
              --set image.tag=${IMAGE_TAG} \
              --wait --timeout 5m
            kubectl rollout status deployment/${RELEASE_NAME}-frontend -n ${NAMESPACE} --timeout=3m
          '''
        }
      }
    }
  }
}

